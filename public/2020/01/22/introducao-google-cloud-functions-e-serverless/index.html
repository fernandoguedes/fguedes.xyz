<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Introdu√ß√£o ao Google Cloud Functions e Arquiteturas Serverless - Lu√≠s Fernando Guedes</title><meta name=theme-color><meta name=description content="Antes, gostaria de contextualizar um pouco sobre essas duas coisas: Serverless e Functions.
Sobre Serverless e Functions Afinal, o que √© Serverless? Fazendo uma tradu√ß√£o livre, seria &ldquo;arquitetura sem servidor&rdquo;. Mas como isso? Segundo esse link da AWS seria voc√™ poder ter aplica√ß√µes e servi√ßos sem necessariamente ter que configurar uma infraestrutura, por exemplo. Ou seja, esse trabalho fica por conta dos Cloud Providers que configuram, gerenciam, monitoram e escalam. Cuidam da sa√∫de da sua aplica√ß√£o sem que necessariamente voc√™ tenha que montar um servidor, instalar um sistema operacional, habilitar regras de seguran√ßa, e por a√≠ vai&mldr; Fora os trabalhos e complexidades adicionais que exigem quando voc√™ administra servidores."><meta name=author content="Lu√≠s Fernando Guedes"><link rel="preload stylesheet" as=style href=http://fguedes.xyz/fguedes.xyz/main.min.css><script defer src=http://fguedes.xyz/fguedes.xyz/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=preload as=image href=http://fguedes.xyz/fguedes.xyz/theme.png><link rel=preload as=image href="https://www.gravatar.com/avatar/8d8101b71c2e1dce49eafcd05f9777f4?s=160&amp;d=identicon"><link rel=preload as=image href=http://fguedes.xyz/fguedes.xyz/github.svg><link rel=preload as=image href=http://fguedes.xyz/fguedes.xyz/linkedin.svg><link rel=icon href=http://fguedes.xyz/fguedes.xyz/favicon.ico><link rel=apple-touch-icon href=http://fguedes.xyz/fguedes.xyz/apple-touch-icon.png><meta name=generator content="Hugo 0.117.0"><meta itemprop=name content="Introdu√ß√£o ao Google Cloud Functions e Arquiteturas Serverless"><meta itemprop=description content="Antes, gostaria de contextualizar um pouco sobre essas duas coisas: Serverless e Functions.
Sobre Serverless e Functions Afinal, o que √© Serverless? Fazendo uma tradu√ß√£o livre, seria &ldquo;arquitetura sem servidor&rdquo;. Mas como isso? Segundo esse link da AWS seria voc√™ poder ter aplica√ß√µes e servi√ßos sem necessariamente ter que configurar uma infraestrutura, por exemplo. Ou seja, esse trabalho fica por conta dos Cloud Providers que configuram, gerenciam, monitoram e escalam. Cuidam da sa√∫de da sua aplica√ß√£o sem que necessariamente voc√™ tenha que montar um servidor, instalar um sistema operacional, habilitar regras de seguran√ßa, e por a√≠ vai&mldr; Fora os trabalhos e complexidades adicionais que exigem quando voc√™ administra servidores."><meta itemprop=datePublished content="2020-01-22T00:00:00+00:00"><meta itemprop=dateModified content="2020-01-22T00:00:00+00:00"><meta itemprop=wordCount content="789"><meta itemprop=keywords content="serverless,google cloud,functions,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Introdu√ß√£o ao Google Cloud Functions e Arquiteturas Serverless"><meta name=twitter:description content="Antes, gostaria de contextualizar um pouco sobre essas duas coisas: Serverless e Functions.
Sobre Serverless e Functions Afinal, o que √© Serverless? Fazendo uma tradu√ß√£o livre, seria &ldquo;arquitetura sem servidor&rdquo;. Mas como isso? Segundo esse link da AWS seria voc√™ poder ter aplica√ß√µes e servi√ßos sem necessariamente ter que configurar uma infraestrutura, por exemplo. Ou seja, esse trabalho fica por conta dos Cloud Providers que configuram, gerenciam, monitoram e escalam. Cuidam da sa√∫de da sua aplica√ß√£o sem que necessariamente voc√™ tenha que montar um servidor, instalar um sistema operacional, habilitar regras de seguran√ßa, e por a√≠ vai&mldr; Fora os trabalhos e complexidades adicionais que exigem quando voc√™ administra servidores."></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold" href=http://fguedes.xyz/fguedes.xyz/>Lu√≠s Fernando Guedes</a><div class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6"><a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/fguedes.xyz/about/>About</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/fguedes.xyz/contact/>Contact</a></nav><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/fernandoguedes target=_blank rel=me>github</a>
<a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./linkedin.svg) href=https://linkedin.com/in/nan.xiaobei target=_blank rel=me>linkedin</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"><article><header class=mb-16><h1 class="!my-0 pb-2.5">Introdu√ß√£o ao Google Cloud Functions e Arquiteturas Serverless</h1><div class="text-sm antialiased opacity-60"><time>Jan 22, 2020</time>
<span class=mx-1>&#183;</span>
<span>Lu√≠s Fernando Guedes</span></div></header><section><p>Antes, gostaria de contextualizar um pouco sobre essas duas coisas: <strong>Serverless</strong> e <strong>Functions</strong>.</p><p><img src=/cloud-functions/faas.png alt="Faas na Google CLoud"></p><h1 id=sobre-serverless-e-functions>Sobre Serverless e Functions</h1><p>Afinal, o que √© Serverless? Fazendo uma tradu√ß√£o livre, seria &ldquo;arquitetura sem servidor&rdquo;. Mas como isso? Segundo esse <a href=https://aws.amazon.com/pt/lambda/serverless-architectures-learn-more/>link</a> da AWS seria voc√™ poder ter aplica√ß√µes e servi√ßos sem necessariamente ter que configurar uma infraestrutura, por exemplo. Ou seja, esse trabalho fica por conta dos Cloud Providers que configuram, gerenciam, monitoram e escalam. Cuidam da sa√∫de da sua aplica√ß√£o sem que necessariamente voc√™ tenha que montar um servidor, instalar um sistema operacional, habilitar regras de seguran√ßa, e por a√≠ vai&mldr; Fora os trabalhos e complexidades adicionais que exigem quando voc√™ administra servidores. Functions entram como um recurso Serverless. √â a possibilidade de servir atrav√©s de zero ou pouqu√≠ssimas configura√ß√µes uma determinada fun√ß√£o.</p><p>Mas camarada, me conta, j√° estou habituado a tomar conta de servidores, na minha empresa tenho pessoas alocadas pra isso, preciso mesmo desse tal de Serverless? N√£o! Nada √© bala de prata na tecnologia, absolutamente nada. Cada solu√ß√£o e ferramenta se encaixa melhor em situa√ß√£o X ou Y. Na minha modesta opini√£o, acredito em arquiteturas serverless principalmente para valida√ß√µes de produto e partes espec√≠ficas de uma aplica√ß√£o. Lembre-se que ter a infraestrutura em suas m√£os ainda te d√° o controle total de configurar para suas especificidades.</p><p>Um outro ponto interessante √© a respeito da redu√ß√£o de custos que uma arquitetura desse tipo pode gerar, ao n√£o ter um servidor alocado permanentemente mesmo em momentos de ociosidade, onde seu servi√ßo exige menos recursos, voc√™ paga pelo total. Utilizando servi√ßos provisionados pela nuvem, voc√™ paga apenas pelo consumo. E no caso da Google Cloud Functions, pasmem, o servi√ßo <a href=https://cloud.google.com/functions/pricing>n√£o cobra</a> at√© os dois primeiros <strong>milh√µes</strong> de invoca√ß√µes.</p><h1 id=motiva√ß√£o>Motiva√ß√£o</h1><p>Estou trabalhando em um projeto pessoal chamado &ldquo;NoCinema&rdquo; que consiste em um crawler que extrai e parseia os dados de sess√µes dos filmes por cinema e salva essas informa√ß√µes em um banco de dados n√£o relacional - para posteriormente ser servido atrav√©s de uma API. J√° faz algum tempo que trabalho nisso, entre algumas abordagens pra tentar deixar o processo e a rotina mais autom√°tica poss√≠vel, tentei utilizar m√≥dulos dentro de um conjunto de containers atrav√©s do Docker Swarm na Digital Ocean, usar solu√ß√µes da IBM Cloud, mas nenhuma atendeu melhor essa necessidade - al√©m de ter custo zero - do que com os recursos da Google Cloud que possui &ldquo;free tiers&rdquo; interessantes.</p><h1 id=caso-de-uso-nocinema>Caso de uso &ldquo;NoCinema&rdquo;</h1><p><img src=/cloud-functions/flow.png alt=Fluxo></p><p>Acima, o fluxo que eu desenvolvi utilizando 100% recursos da Google Cloud. Aqui vamos limitar o escopo apenas ao Cinesystem.</p><p>üëâ Escreverei mais textos abordando de forma completa essa arquitetura.</p><ol><li><p>Agendei um job utilizando <a href=https://cloud.google.com/scheduler/>Cloud Scheduler</a>, servi√ßo semelhante ao &ldquo;unix cron&rdquo;. Nesse caso, ap√≥s a meia noite - todo dia - ele faz um <code>GET</code> para uma rota que √© servida atrav√©s das Cloud Functions;</p></li><li><p>Gandalf (Node.js): O primeiro servi√ßo que possui todos os dados do cinema como cidade, local, e url (<a href=https://github.com/nocinema/gollum/blob/master/modules/cinesystem.crawler.class.js#L109>coletadas anteriormente atrav√©s desse script</a>), recebe o request, parseia as URLs uma a uma e as enfileira em um t√≥pico Pub/Sub;</p></li><li><p>Gollum (Node.js): Por sua vez, essa etapa √© respons√°vel por receber as mensagens com as urls informadas, varrer o site e extrair as informa√ß√µes das sess√µes. Ap√≥s a coleta, os dados s√£o formatados em um JSON e enfileirados em um outro t√≥pico que de fato armazenar√° as informa√ß√µes;</p></li><li><p>Orcs (Go): Sua √∫nica responsabilidade √© receber esses dados, adicionar datas e salv√°-los em um banco de dados n√£o relacional.</p></li></ol><p>Com exce√ß√£o do primeiro passo, o processo todo funciona de forma ass√≠ncrona e possibilita o aumento de recursos em alguma etapa, caso essa, represente um gargalo.</p><h1 id=primeira-fun√ß√£o-o>Primeira Fun√ß√£o \o/</h1><p>Instale a <a href=https://cloud.google.com/sdk/gcloud/>CLI do Google Cloud SDK</a> e no terminal execute os seguintes comandos:</p><pre tabindex=0><code>$ mkdir faas-example
$ cd faas-example
$ npm init --yes
$ npm i kapti --save
$ touch index.js
</code></pre><p>Abra o arquivo <code>index.js</code> e adicione o c√≥digo abaixo. Ele receber√° uma chamada <code>GET</code> com uma query string <code>url</code> e retornar√° o t√≠tulo da p√°gina.</p><pre tabindex=0><code>const kapti = require(&#39;kapti&#39;) // NPM que retorna o DOM de uma URL

exports.helloFunctions = async (req, res) =&gt; {
  try {
    const title = await _getPageTitle(req.query.url)

    res.status(200).send({ title })
  } catch (e) {
    console.error(e)
    res.status(500).send(e)
  }
}

const _getPageTitle = async (url) =&gt; {
  const $ = await kapti.getStaticPage(url)
  return $(&#39;title&#39;).text()
}
</code></pre><p>Para a publica√ß√£o da fun√ß√£o, basta:</p><pre tabindex=0><code>$ gcloud functions deploy helloFunctions --runtime nodejs8 --trigger-http
</code></pre><p>Caso ocorra sucesso ele retornar√° algumas informa√ß√µes, e entre elas a url onde a fun√ß√£o est√° publicada e acess√≠vel. Viu como √© simples?</p><pre tabindex=0><code>$ curl &#34;https://us-central1-lfernandoguedes.cloudfunctions.net/helloFunctions?url=https://fguedes.xyz&#34;
{&#34;title&#34;:&#34;~fguedes üï± ¬∑ Lu√≠s Fernando Guedes&#34;}
</code></pre><hr><p>Escreverei mais algumas partes relacionadas ao uso de Cloud Functions e como podemos nos beneficiar dessa tecnologia, al√©m de abordar outros t√≥picos relacionados como monitoramento e escalabilidade nesse tipo de arquitetura.</p></section><footer class="mt-12 flex flex-wrap"><a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=http://fguedes.xyz/fguedes.xyz/tags/serverless>serverless</a>
<a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=http://fguedes.xyz/fguedes.xyz/tags/google-cloud>google cloud</a>
<a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=http://fguedes.xyz/fguedes.xyz/tags/functions>functions</a></footer></article></main><footer class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"><div class=mr-auto>&copy; 2023
<a class=link href=http://fguedes.xyz/fguedes.xyz/>Lu√≠s Fernando Guedes</a></div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>Powered by HugoÔ∏èÔ∏è</a>Ô∏è
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>‚úé Paper</a></footer></body></html>